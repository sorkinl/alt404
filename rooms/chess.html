<html>

<head>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
  <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>
  <script
    src="https://rawgit.com/mayognaise/aframe-mouse-cursor-component/master/dist/aframe-mouse-cursor-component.min.js"></script>
  <!-- Mesh Inspector -->
  <script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
  
</head>

<body>
  <script>
    const snap = (point, snap, offset) => {
      point.x = Math.floor(point.x / snap.x) * snap.x + offset.x;
      point.z = Math.floor(point.z / snap.z) * snap.z + offset.z;

      return point;
    }
    AFRAME.registerComponent('cursor-listener', {

      init: function () {
        var piece;
        this.el.addEventListener('click', function (evt) {
          console.log(evt.detail)

          if (this.is('selected')) {
            var point = evt.detail.intersection.point;
            console.log(piece + "sel")
            this.removeState('selected');
            var newPos = snap(point, { x: 0.5, z: 0.5 }, { x: 0.25, z: 0.25 })
            piece.setAttribute('position', `${newPos.x} 1.18 ${newPos.z}`);

          } else if (evt.detail.intersectedEl.id != "") {
            piece = document.querySelector("#" + evt.detail.intersectedEl.id);
            console.log(evt.detail.intersectedEl.id)
            this.addState('selected');
            console.log(piece)
          }
        })
      }
    })
  </script>
  <a-scene networked-scene=" app: myApp; room: room1; debug: true;" physics="debug:true;" inspector-plugin-recast
    nav-debug-pointer>
    <!-- Assets -->
    <a-entity position="0 2 -1">
      <a-entity camera look-controls mouse-cursor>
        <a-cursor fuse="false" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: black; shader: flat" cursor-listener></a-cursor>
      </a-entity>
    </a-entity>
    <a-assets>
      <img id="chessboard" src="./img/chessboard.png">
      <img id="sky" src="./img/sky.png">

      <!-- Team 1 Bishops -->
      <a-assets-item id="chess-wBishop-obj" src="assets/Boshop/white.obj"></a-assets-item>
      <a-assets-item id="chess-wBishop-mtl" src="assets/Boshop/white.mtl"></a-assets-item>

      <!-- Team 1 King -->
      <a-assets-item id="chess-wKing-obj" src="assets/King/white.obj"></a-assets-item>
      <a-assets-item id="chess-wKing-mtl" src="assets/King/white.mtl"></a-assets-item>

      <!-- Team 1 Knights -->
      <a-assets-item id="chess-wKnight-obj" src="assets/Knight/white.obj"></a-assets-item>
      <a-assets-item id="chess-wKnight-mtl" src="assets/Knight/white.mtl"></a-assets-item>

      <!-- Team 1 Pawn -->
      <a-assets-item id="chess-wPawn-obj" src="assets/Pawn/white.obj"></a-assets-item>
      <a-assets-item id="chess-wPawn-mtl" src="assets/Pawn/white.mtl"></a-assets-item>

      <!-- Team 1 Queen -->
      <a-assets-item id="chess-wQueen-obj" src="assets/Queen/white.obj"></a-assets-item>
      <a-assets-item id="chess-wQueen-mtl" src="assets/Queen/white.mtl"></a-assets-item>

      <!-- Team 1 Rook -->
      <a-assets-item id="chess-wRook-obj" src="assets/Rook/white.obj"></a-assets-item>
      <a-assets-item id="chess-wRook-mtl" src="assets/Rook/white.mtl"></a-assets-item>

      <!-- Team 2 Bishops -->
      <a-assets-item id="chess-bBishop-obj" src="assets/Boshop/black.obj"></a-assets-item>
      <a-assets-item id="chess-bBishop-mtl" src="assets/Boshop/black.mtl"></a-assets-item>

      <!-- Team 2 King -->
      <a-assets-item id="chess-bKing-obj" src="assets/King/black.obj"></a-assets-item>
      <a-assets-item id="chess-bKing-mtl" src="assets/King/black.mtl"></a-assets-item> 

      <!-- Team 2 Knights -->
      <a-assets-item id="chess-bKnight-obj" src="assets/Knight/black.obj"></a-assets-item>
      <a-assets-item id="chess-bKknight-mtl" src="assets/Knight/black.mtl"></a-assets-item>

      <!-- Team 2 Pawn -->
      <a-assets-item id="chess-bPawn-obj" src="assets/Pawn/black.obj"></a-assets-item>
      <a-assets-item id="chess-bPawn-mtl" src="assets/Pawn/black.mtl"></a-assets-item>

      <!-- Team 2 Queen -->
      <a-assets-item id="chess-bQueen-obj" src="assets/Queen/black.obj"></a-assets-item>
      <a-assets-item id="chess-bQueen-mtl" src="assets/Queen/black.mtl"></a-assets-item>

      <!-- Team 2 Rook -->
      <a-assets-item id="chess-wRook-obj" src="assets/Rook/black.obj"></a-assets-item>
      <a-assets-item id="chess-wRook-mtl" src="assets/Rook/black.mtl"></a-assets-item>

      <!--Movement Mesh-->
      <a-asset-item id="movement-mesh" src="#">
        </a-assets-item>
    </a-assets>

    <!--Sky-->
    <a-sky src="#sky"></a-sky>

    <!--Chessboard-->
    <a-plane src="#chessboard" position="0 1 -4" rotation="-90 0 0" width="4" height="4"></a-plane>

    <!--Ground Plane -->
    <a-plane color="teal" shader="flat" position="0 0 0" rotation="-90 0 0" scale="8 8 8" width="2" height="2">
    </a-plane>

    <!--Movement Mesh-->
    <a-entity gltf-model="#" nav-mesh></a-entity>
    <!-- <a-entity color="#fff" obj-model="obj: #chessboard-set-obj; mtl: #chessboard-set-mtl"></a-entity> -->
    <a-entity id="horsie" rotation="180 0 180" scale="0.25 0.25 0.25" position="1.2 1.18 -2.1" color="#fff"
      obj-model="obj: #chess-wKnight-obj; mtl: #chess-wKnight-mtl"
      event-set__enter="_event: mouseenter; scale: 0.26 0.26 0.26"
      event-set__leave="_event: mouseleave; scale: 0.25 0.25 0.25"></a-entity>

      <a-entity id="horsie2" rotation="180 0 180" scale="0.25 0.25 0.25" position="-1.2 1.18 -2.1" color="#fff"
      obj-model="obj: #chess-wKnight-obj; mtl: #chess-wKnight-mtl"
      event-set__enter="_event: mouseenter; scale: 0.26 0.26 0.26"
      event-set__leave="_event: mouseleave; scale: 0.25 0.25 0.25"></a-entity>
  </a-scene>

</body>

</html>